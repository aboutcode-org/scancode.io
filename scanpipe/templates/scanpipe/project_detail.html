{% extends "scanpipe/base.html" %}
{% load humanize %}

{% block title %}ScanCode.io: {{ project.name }}{% endblock %}

{% block extrahead %}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/billboard.js/2.1.4/theme/datalab.min.css" integrity="sha512-G3049Pa7TYG/+vdsrzH0QA7mWGepHigw/9jO5K21Jz2/0h63kOVsckfLkYofHZANi5WdzT/W1s1xKVetcat6+w==" crossorigin="anonymous" />
<!--  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/billboard.js/2.1.4/theme/graph.min.css" integrity="sha512-paN9cbAXmgFFwEQkjdhrW3BAPg4CsHkD+RSzWJnHMTUnBRdyBTq4iZrjYfajQxTh2jpDhSuu1rGMtFZ0dm0FDA==" crossorigin="anonymous" />-->
<!--  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/billboard.js/2.1.4/theme/insight.min.css" integrity="sha512-tDzlyItqaaYeWYrsIXl3yUcWLhutwUaCUDvCox9LPq0a+ux6Wk28fHWt/t8k6QU51FqhTnVYiPgpe8w1GcGaUg==" crossorigin="anonymous" />-->
{% endblock %}

{% block content %}
  <div class="container is-max-desktop">
    {% include 'scanpipe/includes/navbar_header.html' %}

    <section class="hero">
      <div class="hero-body py-1">
        <div class="container">
          <h1 class="title">
            {{ project.name }}
          </h1>
          <h2 class="subtitle">
            {{ project.created_date }}
          </h2>
          <div class="field is-grouped is-grouped-multiline">
            <div class="control">
              <div class="tags has-addons">
                <span class="tag is-dark">UUID</span>
                <span class="tag is-info">{{ project.uuid }}</span>
              </div>
            </div>
            <div class="control">
              <div class="tags has-addons">
                <span class="tag is-dark">Work directory</span>
                <span class="tag is-info">{{ project.work_directory }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <hr class="mx-5">
    {% include "scanpipe/includes/project_summary_level.html" with project=project title_class="title" include_pipelines=1 only %}

    <section class="section pt-0">
      {% if project.codebaseresources.count or project.discoveredpackages.count %}
        <article class="message is-success">
          <div class="message-body">
            Download results as:
            <a class="tag is-success is-medium ml-2" href="{% url 'project_results' project.uuid 'json' %}">
              JSON <i class="fas fa-download ml-1"></i>
            </a>
            <a class="tag is-success is-medium" href="{% url 'project_results' project.uuid 'xlsx' %}">
              XLSX <i class="fas fa-download ml-1"></i>
            </a>
            <a class="tag is-success is-medium" href="{% url 'project_results' project.uuid 'csv' %}">
              CSV <i class="fas fa-download ml-1"></i>
            </a>
            or
            <a class="has-text-weight-semibold" href="{% url 'project_tree' project.uuid %}">browse the codebase</a>.
          </div>
        </article>
      {% else %}
        <article class="message is-warning">
          <div class="message-body">
            <p class="block">
              Add <strong>Inputs</strong> and run a <strong>Pipeline</strong> to generate some results.
            </p>
          </div>
        </article>
      {% endif %}

      <div class="columns">
        <div class="column">
          <nav class="panel is-info">
            <p class="panel-heading py-2 is-size-6">
              Inputs
            </p>
            {% for input in project.input_root %}
              <span class="panel-block">
                <span class="panel-icon">
                  <i class="fas fa-file" aria-hidden="true"></i>
                </span>
                {{ input }}
              </span>
            {% endfor %}
            <div class="panel-block">
              <button class="button is-link is-outlined is-fullwidth">
                Add input
              </button>
            </div>
          </nav>
        </div>

        <div class="column">
          <nav class="panel is-info">
            <p class="panel-heading py-2 is-size-6">
              Pipelines
            </p>
            {% for run in project.runs.all %}
              <a class="panel-block modal-button" data-target="{{ run.uuid }}-modal" aria-haspopup="true">
                {% include "scanpipe/includes/run_status_tag.html" with run=run only %}
                <span class="ml-2">{{ run.pipeline }}</span>
              </a>
              {% include "scanpipe/includes/run_modal.html" with run=run only %}
            {% endfor %}
            <div class="panel-block">
              <button class="button is-link is-outlined is-fullwidth">
                Add pipeline
              </button>
            </div>
          </nav>
        </div>

      </div>
    </section>

    {% if project.discoveredpackages.count %}
      <hr class="mx-5">
      <h3 class="title is-4 mx-5 has-text-centered">
        Discovered Packages: {{ project.discoveredpackages.count|intcomma }}
      </h3>
      <div class="columns is-gapless">
        <div class="column">
          <div id="packageTypeChart"></div>
        </div>
        <div class="column">
          <div id="packageLicenseChart"></div>
        </div>
      </div>
    {% endif %}

    {% if project.codebaseresources.count %}
      <hr class="mx-5">
      <h3 class="title is-4 mx-5 has-text-centered">
        Codebase Resources: {{ project.codebaseresources.count|intcomma }}
      </h3>
      <div class="columns is-gapless">
        <div class="column">
          <div id="programmingLanguageChart"></div>
        </div>
        <div class="column">
          <div id="mimeTypeChart"></div>
        </div>
      </div>
      <div class="columns is-gapless">
        <div class="column">
          <div id="holderChart"></div>
        </div>
        <div class="column">
          <div id="licenseChart"></div>
        </div>
      </div>
      <div class="columns is-gapless mb-6">
        <div class="column is-half">
          <div id="packageOrphanChart"></div>
        </div>
      </div>
    {% endif %}
  </div>
{% endblock %}

{% block scripts %}
  {% include "scanpipe/includes/modal.js.html" %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/billboard.js/2.1.4/billboard.pkgd.min.js" integrity="sha512-XRQsIslu9KAc6nLfPGDFp7O5H/DNHs1TtKNXJmPKvg5NORgJFN/lbiqcr4ZSLMNZ3nM9Yth4MJLtuMEE/IWdzQ==" crossOrigin="anonymous"></script>
  {{ programming_languages|json_script:"programming_languages" }}
  {{ mime_types|json_script:"mime_types" }}
  {{ holders|json_script:"holders" }}
  {{ licenses|json_script:"licenses" }}
  {{ package_orphans|json_script:"package_orphans" }}
  {{ package_licenses|json_script:"package_licenses" }}
  {{ package_types|json_script:"package_types" }}
  <script>
    let makeChart = function(data_source_id, element_id, title) {
      let data = JSON.parse(document.getElementById(data_source_id).textContent);

      if (Object.keys(data).length === 0)
        return false;

      bb.generate({
        data: {
          columns: Object.entries(data),
          type: "donut",
          colors: {
            "(No value detected)": "rgba(201, 203, 207, 0.5)",
          }
        },
        donut: {
          title: title,
        },
        tooltip: {
          format: {
            value: function(value, ratio, id) {
              let percent = (ratio * 100).toFixed(1);
              return `${value} (${percent}%)`;
            }
          }
        },
        bindto: element_id
     });
    };

    makeChart("programming_languages", "#programmingLanguageChart", "Programming\nLanguage");
    makeChart("mime_types", "#mimeTypeChart", "Mime\nType");
    makeChart("holders", "#holderChart", "Holder");
    makeChart("licenses", "#licenseChart", "License\nKey");
    makeChart("package_orphans", "#packageOrphanChart", "Package\nOrphan");
    makeChart("package_types", "#packageTypeChart", "Package\nType");
    makeChart("package_licenses", "#packageLicenseChart", "Package\nLicense");
  </script>
{% endblock %}