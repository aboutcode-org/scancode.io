{% extends "scanpipe/base.html" %}
{% load static humanize %}
{% block title %}ScanCode.io: {{ project.name }} - Resources tree{% endblock %}

{% block content %}
  <div id="content-header" class="container is-max-widescreen mb-3">
    {% include 'scanpipe/includes/navbar_header.html' %}
    <section class="mx-5">
      <div class="is-flex is-justify-content-space-between">
        {% include 'scanpipe/includes/breadcrumb.html' with linked_project=True current="Resources tree" %}
      </div>
    </section>
  </div>

<div id="resource-tree-container" class="container is-fluid p-0">
  <div class="resizable-container is-flex">
    <div id="left-pane" class="left-pane px-2">
      <div class="mb-3 search-container">
        <div class="field has-addons">
          <div class="control has-icons-left is-expanded">
            <input 
              id="file-search-input" 
              class="input is-small" 
              type="text" 
              placeholder="Go to file..."
              autocomplete="off"
              hx-get="{% url 'codebase_resource_search' project.slug %}"
              hx-target="#search-results"
              hx-trigger="input changed"
              hx-include="this"
              name="search"
            >
            <span class="icon is-small is-left">
              <i class="fas fa-search"></i>
            </span>
          </div>
          <div class="control">
            <button id="clear-search" class="button is-small" type="button">
              <span class="icon is-small">
                <i class="fas fa-times"></i>
              </span>
            </button>
          </div>
        </div>
        <div id="search-results" class="search-dropdown is-hidden"></div>
      </div>
      <div id="resource-tree">
        {% include "scanpipe/panels/codebase_tree_panel.html" with children=children path=path %}
      </div>
    </div>
    <div id="resizer" class="resizer"></div>
    <div id="right-pane" class="right-pane px-2">
      {% if path %}
        <div
          hx-get="{% url 'codebase_resource_table' project.slug %}?path={{ path }}"
          hx-trigger="load"
          hx-target="this">
        </div>
      {% else %}
        {% include "scanpipe/panels/resource_table_panel.html" %}
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script>
    async function toggleFolderNode(folderNode, forceExpand = false) {
      const targetId = folderNode.dataset.target;
      const url = folderNode.dataset.url;
      const target = document.getElementById("dir-" + targetId);
      const chevron = folderNode.querySelector("[data-chevron]");
      
      if (!target || !chevron) return;

      if (target.dataset.loaded === "true") {
        if (forceExpand) {
          target.classList.remove("is-hidden");
          chevron.classList.add("rotated");
        } else {
          target.classList.toggle("is-hidden");
          chevron.classList.toggle("rotated");
        }
      } else {
        target.classList.remove("is-hidden");
        const response = await fetch(url + "&tree_panel=true");
        target.innerHTML = await response.text();
        target.dataset.loaded = "true";
        htmx.process(target);
        chevron.classList.add("rotated");
      }
    }

    async function expandToPath(path) {
      const parts = path.split('/').filter(Boolean);
      let current = "";
      for (const part of parts) {
        current = current ? current + "/" + part : part;
        const folderNode = document.querySelector(`[data-folder][data-path="${current}"]`);
        if (folderNode) await toggleFolderNode(folderNode, true);
      }
      const finalNode = document.querySelector(`[data-folder][data-path="${path}"], .is-file[data-file][data-path="${path}"]`);
      if (finalNode) {
        document.querySelectorAll('.is-current').forEach(el => el.classList.remove('is-current'));
        finalNode.classList.add('is-current');
        finalNode.scrollIntoView({ behavior: "smooth", block: "center" });
      }
    }

    document.addEventListener("click", async e => {
      const node = e.target.closest("[data-folder], .is-file[data-file], .expand-in-tree, [data-chevron]");
      if (!node) return;

      e.preventDefault();
      if (node.matches("[data-chevron]")) {
        await toggleFolderNode(node.closest("[data-folder]"));
      } else if (node.matches("[data-folder], .is-file[data-file], .expand-in-tree")) {
        await expandToPath(node.dataset.path);
      }
    });

    document.addEventListener("DOMContentLoaded", function() {
      const currentPath = "{{ path }}";
      if (currentPath) {
        expandToPath(currentPath);
      }

      const resizer = document.getElementById('resizer');
      const leftPane = document.getElementById('left-pane');
      const rightPane = document.getElementById('right-pane');
      let isResizing = false;

      resizer.addEventListener('mousedown', function(e) {
        isResizing = true;
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });

      document.addEventListener('mousemove', function(e) {
        if (!isResizing) return;
        
        const container = document.querySelector('.resizable-container');
        const containerRect = container.getBoundingClientRect();
        let newLeftWidth = e.clientX - containerRect.left;
        const containerWidth = containerRect.width;
        const resizerWidth = 5;
        const minLeftWidth = 200;
        if (newLeftWidth < minLeftWidth) newLeftWidth = minLeftWidth;
        if (newLeftWidth > containerWidth - resizerWidth) newLeftWidth = containerWidth - resizerWidth;

        const leftPercent = (newLeftWidth / containerWidth) * 100;
        const rightPercent = ((containerWidth - newLeftWidth - resizerWidth) / containerWidth) * 100;

        leftPane.style.flexBasis = leftPercent + '%';
        rightPane.style.flexBasis = rightPercent + '%';
      });

      document.addEventListener('mouseup', function() {
        if (isResizing) {
          isResizing = false;
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });
      
      const searchInput = document.getElementById('file-search-input');
      const searchResults = document.getElementById('search-results');
      const clearSearchBtn = document.getElementById('clear-search');
      
      function toggleSearchResults(show = null) {
        const shouldShow = show !== null ? show : searchInput.value.trim();
        searchResults.classList.toggle('is-hidden', !shouldShow);
      }
      
      function clearSearch() {
        searchInput.value = '';
        toggleSearchResults(false);
        searchInput.focus();
      }
      
      function handleSearchResultClick(searchResultItem) {
        const path = searchResultItem.dataset.path;
        
        toggleSearchResults(false);
        searchInput.blur();
        
        fetch(`{% url 'codebase_resource_table' project.slug %}?path=${encodeURIComponent(path)}`)
          .then(response => response.text())
          .then(html => {
            document.getElementById('right-pane').innerHTML = html;
            htmx.process(document.getElementById('right-pane'));
            if (typeof enableCopyToClipboard === 'function') {
              enableCopyToClipboard('.copy-to-clipboard');
            }
            const newUrl = `{% url 'codebase_resource_tree' project.slug %}?path=${encodeURIComponent(path)}`;
            window.history.pushState(null, '', newUrl);
            expandToPath(path);
          });
      }
      
      searchInput.addEventListener('focus', () => toggleSearchResults());
      searchInput.addEventListener('input', () => toggleSearchResults());
      
      clearSearchBtn.addEventListener('click', clearSearch);
      
      searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          toggleSearchResults(false);
          searchInput.blur();
        }
      });
      
      document.addEventListener('click', function(e) {
        const searchResultItem = e.target.closest('.dropdown-item');
        if (searchResultItem) {
          e.preventDefault();
          handleSearchResultClick(searchResultItem);
          return;
        }
        
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
          toggleSearchResults(false);
        }
      });
      
      document.body.addEventListener('htmx:afterSettle', function(evt) {
        if (evt.target === searchResults) {
          toggleSearchResults();
        }
      });
    });
  </script>
{% endblock %}